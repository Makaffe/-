<as-split direction="vertical" unit="pixel" gutterSize="0" style="background-color: white;">
  <form nz-form #auditPostForm="ngForm">
    <as-split-area class="flex-fixed" [size]="40">
      <div class="app-toor-bar">
        <div nz-row nzType="flex" nzJustify="space-around" nzAlign="middle">
          <div nz-col nzSpan="24">
            <button nz-button (click)="onReturn()"><i nz-icon nzType="rollback" nzTheme="outline"></i>返回</button>
            <button
              (click)="generatePost()"
              nz-button
              nzType="primary"
              nz-button
              style="float:right;margin-top: 10px;"
              nzType="primary"
              *ngIf="!isWatch && currentItem.auditReportStatus != 'GENERATED'"
            >
              <i nz-icon nzType="file-text" nzTheme="outline"></i>生成报告
            </button>
            <button
              nz-button
              nzType="primary"
              nz-button
              style="float:right;margin-top: 10px;"
              nzType="primary"
              *ngIf="!isWatch && currentItem.auditReportStatus != 'GENERATED'"
              (click)="done()"
            >
              <i nz-icon nzType="save" nzTheme="outline"></i>保存
            </button>
          </div>
        </div>
      </div>
    </as-split-area>
    <as-split-area [size]="'*'" style="height:100%;">
      <nz-divider></nz-divider>
      <div style="height:100%;margin-left:10px;margin-top:10px;overflow:scroll;">
        <nz-form-item>
          <nz-form-label nzSpan="3">上传审计报告</nz-form-label>

          <nz-form-control nzSpan="21">
            <nz-upload
              nzAction=""
              [nzCustomRequest]="customReq"
              [nzFileList]="fileList"
              nzMultiple
              [nzShowUploadList]="true"
              [nzLimit]="1"
              [nzFilter]="filters"
              (nzChange)="handleChange($event)"
              [nzRemove]="removeFile"
            >
              <button nz-button nzShape="round" [disabled]="isWatch || currentItem.auditReportStatus == 'GENERATED'">
                <i nz-icon nzType="upload"></i><span>上传文件</span>
              </button>
            </nz-upload>
          </nz-form-control>
        </nz-form-item>
        <nz-form-item>
          <nz-form-label nzSpan="3">报告内容提取</nz-form-label>
          <nz-form-control nzSpan="21">
            <button (click)="downLoadPostFile()" [disabled]="!currentItem.systemFile" nz-button nzShape="round">
              <i nz-icon nzType="download" nzTheme="outline"></i>下载报告
            </button>
            <button (click)="previewPostFile()" [disabled]="!currentItem.systemFile" nz-button nzShape="round">
              <i nz-icon nzType="zoom-in" nzTheme="outline"></i>查看报告
            </button>
            <button
              *ngIf="!isWatch"
              [disabled]="!currentItem.systemFile || isWatch || currentItem.auditReportStatus == 'GENERATED'"
              nz-button
              nzShape="round"
            >
              <i nz-icon nzType="file-search" nzTheme="outline"></i>开始读取
            </button>
          </nz-form-control>
        </nz-form-item>

        <!--基本信息-->
        <nz-form-item>
          <nz-form-label nzSpan="3" nzRequired>审计报告名称</nz-form-label>
          <nz-form-control nzSpan="21" [nzValidateStatus]="name.invalid && (name.dirty || name.touched) ? 'error' : ''">
            <input
              nz-input
              required
              [disabled]="isWatch || currentItem.auditReportStatus == 'GENERATED'"
              #name="ngModel"
              name="name"
              [(ngModel)]="currentItem.name"
            />
            <nz-form-explain *ngIf="name.invalid && (name.dirty || name.touched)">
              请填写审计报告名称
            </nz-form-explain>
          </nz-form-control>
        </nz-form-item>
        <nz-form-item>
          <nz-form-label nzSpan="3" nzRequired>审计单位名称</nz-form-label>
          <nz-form-control
            nzSpan="21"
            [nzValidateStatus]="auditName.invalid && (auditName.dirty || auditName.touched) ? 'error' : ''"
          >
            <input
              nz-input
              required
              [disabled]="isWatch || currentItem.auditReportStatus == 'GENERATED'"
              #auditName="ngModel"
              name="auditName"
              [(ngModel)]="currentItem.auditName"
            />

            <nz-form-explain *ngIf="auditName.invalid && (auditName.dirty || auditName.touched)">
              请填写审计单位名称
            </nz-form-explain>
          </nz-form-control>
        </nz-form-item>
        <nz-form-item>
          <nz-form-label nzSpan="3" nzRequired>被审计对象名称</nz-form-label>
          <nz-form-control
            nzSpan="21"
            [nzValidateStatus]="reauditName.invalid && (reauditName.dirty || reauditName.touched) ? 'error' : ''"
          >
            <input
              nz-input
              required
              [disabled]="isWatch || currentItem.auditReportStatus == 'GENERATED'"
              #reauditName="ngModel"
              name="reauditName"
              [(ngModel)]="currentItem.reauditName"
            />

            <nz-form-explain *ngIf="auditName.invalid && (auditName.dirty || auditName.touched)">
              请填写被审计对象名称
            </nz-form-explain>
          </nz-form-control>
        </nz-form-item>
        <nz-form-item>
          <nz-form-label nzSpan="3" nzRequired>审计时间</nz-form-label>
          <nz-form-control
            nzSpan="9"
            [nzValidateStatus]="
              auditDateRange.invalid && (auditDateRange.dirty || auditDateRange.touched) ? 'error' : ''
            "
          >
            <nz-range-picker
              required
              [nzDisabled]="isWatch || currentItem.auditReportStatus == 'GENERATED'"
              #auditDateRange="ngModel"
              name="auditDateRange"
              [(ngModel)]="currentItem.auditDateRange"
            ></nz-range-picker>
            <nz-form-explain *ngIf="auditDateRange.invalid && (auditDateRange.dirty || auditDateRange.touched)">
              请选择审计时间
            </nz-form-explain>
          </nz-form-control>
          <nz-form-label nzSpan="3" nzRequired>报告来源</nz-form-label>
          <nz-form-control
            nzSpan="9"
            [nzValidateStatus]="reportSource.invalid && (reportSource.dirty || reportSource.touched) ? 'error' : ''"
          >
            <nz-select
              required
              name="reportSource"
              #reportSource="ngModel"
              nzShowSearch
              [nzDisabled]="isWatch || currentItem.auditReportStatus == 'GENERATED'"
              nzAllowClear
              nzPlaceHolder="请选择报告来源"
              [(ngModel)]="currentItem.reportSource"
            >
              <nz-option nzLabel="内部审计" nzValue="MRF_REPORT_SOURCE"></nz-option>
              <nz-option nzLabel="迎审项目" nzValue="MRF_REPORT_SOURCE"></nz-option>
              <nz-option nzLabel="外聘审计" nzValue="MRF_REPORT_SOURCE"></nz-option>
            </nz-select>
            <nz-form-explain *ngIf="reportSource.invalid && (reportSource.dirty || reportSource.touched)">
              请选择报告来源
            </nz-form-explain>
          </nz-form-control>
        </nz-form-item>
        <nz-form-item>
          <nz-form-label nzSpan="3">附件</nz-form-label>
          <nz-form-control nzSpan="21">
            <app-attach-list
              [show]="!isWatch"
              [(attachFiles)]="currentItem.systemFiles"
              #attachListComponent
              [fileType]="'AUDIT_POST_FILES'"
            >
            </app-attach-list>
          </nz-form-control>
        </nz-form-item>
        <nz-form-item>
          <nz-form-label nzSpan="3">审计发现清单</nz-form-label>
          <nz-form-control nzSpan="21">
            <nz-table #columnTable nzBordered [nzData]="listOfData" [nzScroll]="{ x: '900px' }">
              <thead>
                <tr>
                  <th nzWidth="50px" nzAlign="center" nzLeft="0px">序号</th>
                  <th nzWidth="100px" nzAlign="center" nzLeft="50px">问题名称</th>
                  <th nzWidth="100px" nzAlign="center">问题类型</th>
                  <th nzWidth="100px" nzAlign="center">整改部门</th>
                  <th nzWidth="100px" nzAlign="center">整改责任人</th>
                  <th nzWidth="100px" nzAlign="center">涉及金额</th>
                  <th nzWidth="100px" nzAlign="center">问题描述</th>
                  <th nzWidth="100px" nzAlign="center">审计建议</th>
                  <th nzRight="100px" nzAlign="center" nzWidth="100px">问题来源</th>
                  <th nzWidth="150px" nzAlign="center" nzRight="0px">
                    操作
                    <button
                      nz-button
                      [nzSize]="'small'"
                      nzType="primary"
                      *ngIf="!isWatch && currentItem.auditReportStatus != 'GENERATED'"
                      (click)="addProblem()"
                    >
                      增加
                    </button>
                  </th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let data of columnTable.data; let i = index">
                  <td nzAlign="center" nzLeft="0px">
                    {{
                      ((columnTable.nzPageIndex ? columnTable.nzPageIndex : 1) - 1) *
                        (columnTable.nzPageSize ? columnTable.nzPageSize : 0) +
                        (i + 1)
                    }}
                  </td>

                  <td nzLeft="50px">
                    {{ data.name }}
                  </td>
                  <td>{{ data.type | dictTransform: 'PROBLEM_TYPE' | async }}</td>
                  <td>{{ data?.rectifyDepartment?.name }}</td>
                  <td>{{ data?.dutyUser?.name }}</td>
                  <td>{{ data.money }}</td>
                  <td>{{ data.remark }}</td>
                  <td>{{ data.advice }}</td>
                  <td nzRight="100px">
                    {{ data.source }}
                  </td>

                  <td nzAlign="center" nzRight="0px">
                    <a *ngIf="isWatch || currentItem.auditReportStatus == 'GENERATED'" (click)="editProblem(data, true)"
                      >查看</a
                    >
                    <a
                      (click)="editProblem(data, false)"
                      *ngIf="!data.editable && !isWatch && currentItem.auditReportStatus != 'GENERATED'"
                      >编辑</a
                    >
                    <nz-divider nzType="vertical"></nz-divider>
                    <nz-popconfirm [nzTitle]="confirmtittle" (nzOnConfirm)="deleteProblem(data)">
                      <ng-template #confirmtittle>是否要删除该条数据</ng-template>
                      <a
                        *ngIf="isWatch || currentItem.auditReportStatus == 'GENERATED'"
                        style="pointer-events: none;color: #666666; opacity: 0.5"
                        >删除</a
                      >
                      <a *ngIf="!isWatch && currentItem.auditReportStatus != 'GENERATED'" nz-popconfirm>删除</a>
                    </nz-popconfirm>
                  </td>
                </tr>
              </tbody>
            </nz-table>
          </nz-form-control>
        </nz-form-item>
      </div>
    </as-split-area>
  </form>
</as-split>
<nz-modal
  [(nzVisible)]="isVisabled"
  nzTitle="整改问题清单详情"
  (nzOnCancel)="handleCancel()"
  (nzOnOk)="handleOk()"
  nzWidth="1200px"
>
  <form nz-form #problemform="ngForm">
    <nz-form-item nz-row>
      <nz-form-label [nzSpan]="4" nzRequired>整改部门</nz-form-label>
      <nz-form-control
        [nzSpan]="20"
        [nzValidateStatus]="
          rectifyDepartmentId.invalid && (rectifyDepartmentId.dirty || rectifyDepartmentId.touched) ? 'error' : ''
        "
      >
        <nz-tree-select
          [nzNodes]="organizationTree"
          nzDefaultExpandAll
          nzShowSearch
          nzAllowClear="true"
          name="rectifyDepartmentId"
          [(ngModel)]="paramsItem.rectifyDepartmentId"
          [nzDropdownStyle]="{ maxHeight: '280px' }"
          #rectifyDepartmentId="ngModel"
          required
        >
        </nz-tree-select>
      </nz-form-control>
    </nz-form-item>
    <nz-form-item nz-row>
      <nz-form-label [nzSpan]="4" nzRequired>问题名称</nz-form-label>
      <nz-form-control [nzSpan]="8">
        <input
          [readOnly]="lookup"
          required
          nz-input
          name="paramsItem.name"
          [pattern]="PATTERN"
          required
          [(ngModel)]="paramsItem.name"
        />
      </nz-form-control>
      <nz-form-label [nzSpan]="4" nzRequired>问题类型</nz-form-label>
      <nz-form-control [nzSpan]="8">
        <app-dict-select
          required
          [dictCode]="'PROBLEM_TYPE'"
          nzAllowClear
          [placeHolder]="'请选择问题类型'"
          #problemType="ngModel"
          name="paramsItem.type"
          [(ngModel)]="paramsItem.type"
        >
        </app-dict-select>
      </nz-form-control>
    </nz-form-item>

    <nz-form-item nz-row>
      <nz-form-label [nzSpan]="4" nzRequired>整改负责人</nz-form-label>
      <nz-form-control
        [nzSpan]="8"
        [nzValidateStatus]="dutyUserId.invalid && (dutyUserId.dirty || dutyUserId.touched) ? 'error' : ''"
      >
        <nz-select
          name="dutyUserId"
          [(ngModel)]="paramsItem.dutyUserId"
          style="width: 100%;"
          nzShowSearch="true"
          nzAllowClear="true"
          #dutyUserId="ngModel"
          required
        >
          <nz-option *ngFor="let option of dutyUserList" [nzLabel]="option.name" [nzValue]="option.id"> </nz-option>
        </nz-select>
      </nz-form-control>
      <nz-form-label [nzSpan]="4" nzRequired>问题来源</nz-form-label>
      <nz-form-control [nzSpan]="8">
        <input
          [readOnly]="lookup"
          required
          nz-input
          name="paramsItem.source"
          [pattern]="PATTERN"
          required
          [(ngModel)]="paramsItem.source"
        />
      </nz-form-control>
    </nz-form-item>
    <nz-form-item nz-row>
      <nz-form-label [nzSpan]="4">涉及金额</nz-form-label>
      <nz-form-control [nzSpan]="8">
        <input
          [readOnly]="lookup"
          nz-input
          name="paramsItem.money"
          [pattern]="PATTERN"
          required
          [(ngModel)]="paramsItem.money"
        />
      </nz-form-control>
    </nz-form-item>
    <nz-form-item nz-row>
      <nz-form-label [nzSpan]="4" nzRequired>问题描述</nz-form-label>
      <nz-form-control [nzSpan]="20">
        <textarea
          [readOnly]="lookup"
          nz-input
          name="paramsItem.remark"
          [(ngModel)]="paramsItem.remark"
          required
          rows="6"
        ></textarea>
      </nz-form-control>
    </nz-form-item>
    <nz-form-item nz-row>
      <nz-form-label [nzSpan]="4" nzRequired>整改建议</nz-form-label>
      <nz-form-control [nzSpan]="20">
        <textarea
          [readOnly]="lookup"
          nz-input
          name="paramsItem.advice"
          [(ngModel)]="paramsItem.advice"
          required
          rows="6"
        ></textarea>
      </nz-form-control>
    </nz-form-item>
  </form>
</nz-modal>
